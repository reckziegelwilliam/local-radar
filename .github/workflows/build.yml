name: EAS Build

on:
    push:
        branches: [main]
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            platform:
                description: "Platform to build"
                required: true
                default: "all"
                type: choice
                options:
                    - all
                    - ios
                    - android
            profile:
                description: "Build profile"
                required: true
                default: "preview"
                type: choice
                options:
                    - development
                    - preview
                    - production

jobs:
    build:
        name: EAS Build
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20.x"
                  cache: "npm"

            - name: Setup Expo
              uses: expo/expo-github-action@v8
              with:
                  expo-version: latest
                  eas-version: latest
                  token: ${{ secrets.EXPO_TOKEN }}

            - name: Install dependencies
              run: npm ci

            - name: Build on EAS
              run: |
                  PLATFORM="${{ github.event.inputs.platform || 'all' }}"
                  PROFILE="${{ github.event.inputs.profile || 'preview' }}"
                  eas build --platform $PLATFORM --profile $PROFILE --non-interactive

            - name: Notify on success
              if: success()
              run: echo "Build completed successfully!"

            - name: Notify on failure
              if: failure()
              run: echo "Build failed!"
